package dns;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.LinkedList;

public class hosts {

	final static String USERAGENT = "yeet";
    final static String DOMAIN = "http://google.com/";

	public static void main(String[] args) {
		boolean checked = checkDomain();
        if (checked == true) {
            vm.vm.checkVM("Windows");
        } else {
            System.out.println("[-] Exiting - running in an incorrect environment");
        }
	}

	private static boolean checkDomain() {
		try {
			URL obj = new URL(DOMAIN);
			HttpURLConnection con = (HttpURLConnection) obj.openConnection();
			con.setRequestMethod("GET");
			con.setRequestProperty("User-Agent", USERAGENT);
			int responseCode = con.getResponseCode();
            System.out.println(responseCode);
            System.out.println("[-] Connected to the internet");
			return false;
		} catch (IOException e) {
            // C:\Windows\System32\drivers\etc\hosts
            // /etc/hosts
            
            String OSName = os.checkOS();
            File file;
            if (OSName == "Linux") {
                file = new File("/etc/hosts");
                //TODO maybe use system instead? cat /etc/hosts | grep "google.com"
            } else if (OSName == "Windows") {
                file = new File("C:\\Windows\\System32\\drivers\\etc\\hosts");
                
            } else {
                OSName = null;
                System.out.println("[-] Unknown OS, exiting");
                return false;
            }
            System.out.println("[*] " + OSName);
            System.out.println("[+] Not connected to the internet");
            System.out.println("[*] Checking if this was caused by a fault in etc/hosts...");
            boolean hostsCheck = hostsFile(file);
            if (hostsCheck == false) {
                System.out.println("[-] Dodgy hosts entry found");
                return false;
            } else {
                System.out.println("[+] Nothing bad found");
            }
            System.out.println("[*] Virtualisation tests");
            System.out.println("All good");
            //return vm.vm.checkVM(OSName);
			return true;

		}
    }
    
    private static boolean hostsFile(File file) {

        String host = "";
        boolean domainFound;
        LinkedList<String> hostsEntries = new LinkedList<String>();       
        //File file = new File("doc.txt");
        try (InputStream in = new FileInputStream(file)) {
            int content;
            while ((content = in.read()) != -1) {
                //System.out.print((char)content);
                if ((char)content=='\n'){
                    //System.out.println("HOSTSS" + host);
                    hostsEntries.add(host);
                    host = "";
                } else {
                    host += (char)content;
                }
                
                //hosts += 
            }
            for(int p=0; p < hostsEntries.size(); p++) {
                //System.out.println("Entry at index " + p + ": " + hostsEntries.get(p));
                if (hostsEntries.get(p).charAt(0)=='#') {
                    hostsEntries.remove(p);
                    p--;
                } 
            }
            //System.out.println("\n\n\nattempt 2\n\n\n");
           
            for(int p=0; p < hostsEntries.size(); p++) {
                //System.out.println("Entry at index " + p + ": " + hostsEntries.get(p));
                domainFound = hostsEntries.get(p).indexOf(DOMAIN.substring(7,DOMAIN.length())) !=-1 ? true : false;
                if (domainFound == true) return false;
            }
            return true;

        } catch (Exception e) {
            System.out.println("An error has occured:\n");
            e.printStackTrace();
            return false;
        }
        
        
        //return true;
    }

}
