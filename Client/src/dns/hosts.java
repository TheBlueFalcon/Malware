package dns;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.LinkedList;

public class hosts {

	final static String USERAGENT = "yeet";
    final static String DOMAIN = "http://google.com/";

	public static void main(String[] args) {
		boolean checked = checkDomain();
        if (checked == true) {
            vm.vm.checkVM("Windows");
        } else {
            general.exit.exiting();
        }
    }

	private static boolean checkDomain() {
		try {
			URL obj = new URL(DOMAIN);
			HttpURLConnection con = (HttpURLConnection) obj.openConnection();
			con.setRequestMethod("GET");
			con.setRequestProperty("User-Agent", USERAGENT);
			int responseCode = con.getResponseCode();
            System.out.printf("[*] Response Code: %s\n", responseCode);
            System.out.println("[-] Connected to the internet");
			return false;
		} catch (IOException e) {
            // C:\Windows\System32\drivers\etc\hosts
            // /etc/hosts
            
            String OSName = general.os.checkOS();
            File file;
            if (OSName == "Linux") {
                file = new File("/etc/hosts");
                //TODO maybe use system instead? cat /etc/hosts | grep "google.com"
            } else if (OSName == "Windows") {
                file = new File("C:\\Windows\\System32\\drivers\\etc\\hosts");
                
            } else {
                OSName = null;
                System.out.println("[-] Unknown OS, exiting");
                return false;
            }
            System.out.println("[*] " + OSName);
            System.out.println("[+] Not connected to the internet");
            System.out.println("[*] Checking if this was caused by a fault in etc/hosts...");
            boolean hostsCheck = hostsFile(file);
            if (hostsCheck == false) {
                System.out.printf("[-] Address of %s appears in hosts\n", DOMAIN);
                return false;
            } else {
                System.out.println("[+] Nothing bad found");
            }
            System.out.println("[*] Virtualisation tests");
            System.out.println("All good");
            //return vm.vm.checkVM(OSName);
			return true;

		}
    }
    
    private static boolean hostsFile(File file) {

        String host = "";
        boolean domainFound;
        LinkedList<String> hostsEntries = new LinkedList<String>();       
        try (InputStream in = new FileInputStream(file)) {
            int content;
            while ((content = in.read()) != -1) {
                if ((char)content=='\n'){
                    hostsEntries.add(host);
                    host = "";
                } else {
                    host += (char)content;
                }
            }
            for(int p=0; p < hostsEntries.size(); p++) {
                if (hostsEntries.get(p).charAt(0)=='#') {
                    hostsEntries.remove(p);
                    p--;
                } 
            }
           
            for(int p=0; p < hostsEntries.size(); p++) {
                domainFound = hostsEntries.get(p).indexOf(DOMAIN.substring(7,DOMAIN.length())) !=-1 ? true : false;
                if (domainFound == true) return false;
            }
            return true;

        } catch (Exception e) {
            System.out.println("An error has occured:\n");
            return false;
        }
    }

}
