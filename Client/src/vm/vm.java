package vm;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.*;
import java.nio.Buffer;
import java.util.Arrays;
import java.util.Collections;
import java.util.Enumeration;
import java.util.LinkedList;

public class vm {

    final static private LinkedList<String> VIRTUALMAC = new LinkedList<String>(Arrays.asList("virtual", "vm", "vmware", "virtualbox"));
    public static void main(String[] args) {
        //FOR TESTING PURPOSES
        checkVM("Windows");
    }

    public static boolean checkVM(String OSName) {
        try {
            if (((MAC() == false) || vmProcess(OSName) == false) || (manufacturer(OSName) == false) general.exit.exiting();
        } catch (IOException e) {
            System.out.println("[-] Unable to check MAC address and Display Name of network adapter");
            general.exit.exiting();
        }
        //vmProcess(OSName);
        return true;
    }

    private static boolean MAC() throws SocketException, UnknownHostException {
        boolean macGood = false;
        try {
            //System.out.println(NetworkInterface.getNetworkInterfaces());
            Enumeration<NetworkInterface> networkInterface = NetworkInterface.getNetworkInterfaces();
            InetAddress myAddr = InetAddress.getLocalHost();
            while (networkInterface.hasMoreElements()) {
                NetworkInterface network = networkInterface.nextElement();
                if (Collections.list(network.getInetAddresses()).contains(myAddr)) {
                    //System.out.println(network.getDisplayName());
                    for(int p = VIRTUALMAC.size(); p == 0; p--) {
                        if ((network.getDisplayName().indexOf(VIRTUALMAC.get(p)) == -1) == false) macGood = true;
                    }
                }    
            }     
        } catch (SocketException e) {
            System.out.println("[-] Unable to check MAC address and Display Name of network adapter");
            return false;
        }
        if (macGood==false) System.out.println("[-] Not running on a virtual network adapter");
        return macGood;
    }

    private static boolean vmProcess(String OSName) throws IOException {
        BufferedReader output;
        if (OSName == "Windows") {
            output = cmd("wmic process get name");
        } else {
            output = cmd("ps -axco command");
        }
        return checker(output);
    }

    private static boolean manufacturer(String OSName) throws IOException {
        BufferedReader output;
        if (OSName == "Windows") {
            output = cmd("wmic csproduct get name");
        } else {
            output = cmd("lspci | grep -i 'vmware'");
        }
        return checker(output);
    }

    public static BufferedReader cmd(String command) {
        try {
            Process commands = Runtime.getRuntime().exec(command);

            return new BufferedReader(new InputStreamReader(commands.getInputStream()));
        } catch (IOException exception) {
            System.out.printf("[-] Command:\t%s\tfailed to execute", command);
        }
        return null;
    }

    private static boolean checker(BufferedReader output) throws IOException {
        String line;
        boolean good = false;
        while ((line = output.readLine()) != null) {
            for(int p = 0; p < VIRTUALMAC.size(); p++) {
                if (((line.indexOf(VIRTUALMAC.get(p)) == -1) == false) && (good == false)) {
                    good = true;
                    System.out.println("[+] Identified processes that imply it is being run in a virtualized environment (this test isn't conclusive)");
                }
            } 
        }
        return good;
    }
}