package vm;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.*;
import java.util.Arrays;
import java.util.Collections;
import java.util.Enumeration;
import java.util.LinkedList;

public class vm {

    final static private LinkedList<String> VIRTUALMAC = new LinkedList<String>(Arrays.asList("virtual", "vm", "vmware", "virtualbox"));
    public static void main(String[] args) {
        //FOR TESTING PURPOSES
        checkVM("Windows");
    }

    public static boolean checkVM(String OSName) {
        try {
            //if (MAC() == false) return false;
            boolean temp = MAC();
            vmProcess(OSName);
        } catch (IOException e) {
            System.out.println("[-] Unable to check MAC address and Display Name of network adapter");
        }
        //vmProcess(OSName);
        return true;
    }

    private static boolean MAC() throws SocketException, UnknownHostException {
        boolean macGood = false;
        try {
            //System.out.println(NetworkInterface.getNetworkInterfaces());
            Enumeration<NetworkInterface> networkInterface = NetworkInterface.getNetworkInterfaces();
            InetAddress myAddr = InetAddress.getLocalHost();
            while (networkInterface.hasMoreElements()) {
                NetworkInterface network = networkInterface.nextElement();
                if (Collections.list(network.getInetAddresses()).contains(myAddr)) {
                    //System.out.println(network.getDisplayName());
                    for(int p = VIRTUALMAC.size(); p == 0; p--) {
                        if ((network.getDisplayName().indexOf(VIRTUALMAC.get(p)) == -1) == false) macGood = true;
                    }
                }    
            }     
        } catch (SocketException e) {
            System.out.println("[-] Unable to check MAC address and Display Name of network adapter");
            return false;
        }
        if (macGood==false) System.out.println("[-] Not running on a virtual network adapter");
        return macGood;
    }

    private static boolean vmProcess(String OSName) throws IOException {
        BufferedReader output;
        String line;
        boolean processGood = false;
        if (OSName == "Windows") {
            output = cmd("wmic process get name");
        } else {
            output = cmd("ps -axco commad");
        }
        while ((line = output.readLine()) != null) {
            for(int p = 0; p < VIRTUALMAC.size(); p++) {
                if (((line.indexOf(VIRTUALMAC.get(p)) == -1) == false) && (processGood == false)) {
                    processGood = true;
                    System.out.println("[+] Identified processes that imply it is being run in a virtualized environment");
                }
            } 
        }
     
        output.close();
        return processGood;
    }

    public static BufferedReader cmd(String command) {
        try {
            Process commands = Runtime.getRuntime().exec(command);

            return new BufferedReader(new InputStreamReader(commands.getInputStream()));
        } catch (IOException exception) {
            System.out.printf("[-] Command:\t%s\tfailed to execute", command);
        }
        return null;
    }
}