package vm;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.*;
import java.util.Arrays;
import java.util.Collections;
import java.util.Enumeration;
import java.util.LinkedList;
import java.util.Scanner;

public class vm {

    final static private LinkedList<String> VIRTUALMAC = new LinkedList<String>(Arrays.asList("virtual", "vm", "vmware", "virtualbox"));
    public static void main(String[] args) {
        //FOR TESTING PURPOSES
        checkVM("Windows");
    }

    public static boolean checkVM(String OSName) {
        try {
            //if (MAC() == false) return false;
            boolean temp = MAC();
            System.out.println("GOOD");
            vmProcess(OSName);
        } catch (IOException e) {
            System.out.println("[-] Unable to check MAC address and Display Name of network adapter");
        }
        //vmProcess(OSName);
        return true;
    }

    private static boolean MAC() throws SocketException, UnknownHostException {
        boolean macGood = false;
        try {
            System.out.println(NetworkInterface.getNetworkInterfaces());
            Enumeration<NetworkInterface> networkInterface = NetworkInterface.getNetworkInterfaces();
            InetAddress myAddr = InetAddress.getLocalHost();
            while (networkInterface.hasMoreElements()) {
                NetworkInterface network = networkInterface.nextElement();
                if (Collections.list(network.getInetAddresses()).contains(myAddr)) {
                    System.out.println(network.getDisplayName());
                    for(int p = VIRTUALMAC.size(); p == 0; p--) {
                        if ((network.getDisplayName().indexOf(VIRTUALMAC.get(p)) == -1) == false) macGood = true;
                    }
                }    
            }     
        } catch (SocketException e) {
            System.out.println("[-] Unable to check MAC address and Display Name of network adapter");
            return false;
        }
        if (macGood==false) System.out.println("[-] Not running on a virtual network adapter");
        return macGood;
    }

    private static boolean vmProcess(String OSName) throws IOException {
        BufferedReader output;
        String line;
        if (OSName == "Windows") {
            output = cmd("wmic process get name");
        } else {
            output = cmd("ps -axco commad");
        }
        System.out.println("GOT THIS FAR");
       while ((line = output.readLine()) != null) {
            System.out.println(line);
        }
     
        output.close();
        return true;
    }

    public static BufferedReader cmd(String command) {
        System.out.println(command);
        try {
            Process commands = Runtime.getRuntime().exec(command);
            BufferedReader output = new BufferedReader(new InputStreamReader(commands.getInputStream()));
 
            return output;
        } catch (IOException exception) {
            System.out.printf("[-] Command:\t%s\tfailed to execute", command);
        }
        return null;
    }
}