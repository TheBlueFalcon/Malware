package main;

import java.awt.*; 
import java.awt.event.*;
import javax.swing.*; 
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;

import jdk.nashorn.internal.runtime.options.Options;

import java.lang.*;
import java.util.Arrays;

import remote.Connect;

public class GUI extends JFrame {

	static JLabel label;
	static JTabbedPane tabbedPane;
	static JPanel threadsPanel;
	static JPanel chatPanel;
	static JPanel panelThree;
	static JComboBox<String> dropDown;

	public GUI() {

		Container cp = getContentPane();

		GroupLayout layout = new GroupLayout(cp);
		cp.setLayout(layout);

		tabbedPane = new JTabbedPane();
		threadsPanel = initThreads();
		add(threadsPanel);
		chatPanel = initChat();
		add(chatPanel);
		panelThree = new JPanel();
		// threadsPanel.setLayout(null);

		tabbedPane.addTab("Connections", threadsPanel);

		tabbedPane.addTab("Chat", chatPanel);

		panelThree.setLayout(null);
		tabbedPane.addTab("tab3", panelThree);
		tabbedPane.addChangeListener(new ChangeListener() {

			@Override
			public void stateChanged(ChangeEvent e) {
				if (e.getSource() instanceof JTabbedPane) {
					JTabbedPane pane = (JTabbedPane) e.getSource();
					int panelNo = pane.getSelectedIndex();
					switch (panelNo) {
						case 0:
							updateThreads();
							break;
						case 1:
							//initChat();
							break;
					}
				}
			}
		});

		layout.setHorizontalGroup(
				layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addComponent(tabbedPane));
		layout.setVerticalGroup(
				layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addComponent(tabbedPane));
		pack();

		setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);

		setTitle("Malware Server"); // "super" JFrame sets title
		/*
		 * setExtendedState(JFrame.MAXIMIZED_BOTH); setUndecorated(true);
		 * setVisible(true);
		 */
		setSize(750, 750); // "super" JFrame sets initial size
		setVisible(true); // "super" JFrame shows
	}

	public static void addConn(String threadName) {
		JButton newButton = new JButton(threadName);
		threadsPanel.add(newButton);
		threadsPanel.revalidate();
		threadsPanel.repaint();
		dropDown.addItem(threadName);
	}

	private JPanel initChat() {
		chatPanel = new JPanel();
		
		chatPanel.setLayout(new GridBagLayout());
		GridBagConstraints c = new GridBagConstraints();
		//String[] test = {"a","b","c"};
		dropDown = new JComboBox<>();
		dropDown.addItem("Please do something");
		System.out.println("aaaaa" + Arrays.toString(Connect.activeConnections.keySet().toArray(new String[0])));
		MutableComboBoxModel model = (MutableComboBoxModel)dropDown.getModel();
		//for (String s : Connect.activeConnections.keySet().toArray(new String[0])) {
			//model.addElement(s);
			//dropDown.addItem(s);
			//dropDown.repaint();
			//dropDown.validate();
		//}

		JButton refresh = new JButton("Start chat with localhost");
		refresh.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				if (dropDown.getSelectedItem() == dropDown.getItemAt(0)) {
					JOptionPane.showMessageDialog(null, "Error: cant select this option.", "Malware Server: Error", JOptionPane.INFORMATION_MESSAGE);
				} else {
					Connect.activeConnections.get(dropDown.getSelectedItem()).chat();
					System.out.println("Button pressed");	
				}		
			}
		});

		c.fill = GridBagConstraints.HORIZONTAL;
		c.ipady = 40; // make this component tall
		c.weightx = 0.0;
		c.gridwidth = 3;
		c.gridx = 0;
		c.gridy = 0;
		chatPanel.add(refresh, c);
		c.gridy = 1;
		chatPanel.add(dropDown, c);
		chatPanel.updateUI();
		//Connect.activeConnections.keySet().toArray(new String[0])
		return chatPanel;
	}

	private JPanel initThreads() {
		JPanel threadsPanel = new JPanel();
		
		threadsPanel.setLayout(new GridBagLayout());
		GridBagConstraints c = new GridBagConstraints();

		JButton refresh = new JButton("Refresh");
		refresh.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				updateThreads();				
			}
		});

		c.fill = GridBagConstraints.HORIZONTAL;
		c.ipady = 40; // make this component tall
		c.weightx = 0.0;
		c.gridwidth = 3;
		c.gridx = 3;
		c.gridy = 3;
		threadsPanel.add(refresh, c);

		return threadsPanel;
	}

	public void updateThreads() {
		Component[] components = threadsPanel.getComponents();
		for (Component jb : components) {

			System.out.println(((JButton)jb).getText());
			if ((jb.toString().indexOf("JButton") != -1) && ((JButton)jb).getText() != "Refresh") {
				threadsPanel.remove(jb);
			}
			
		}
		threadsPanel.revalidate();
		threadsPanel.repaint();
		/*try {
			//Thread.sleep(1500); //add some lag to make it feel authentic
		} catch (InterruptedException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}*/
		initThreads();
		/*for (Thread t : Thread.getAllStackTraces().keySet()) {
			if (t.toString().indexOf(".") != -1) {
				addConn(t.getName());
			}
		}*/
		remote.ClientHandler.checkConnection();
	}

}	

class ThreadsPanel extends JPanel {

	int i = 0;

	public ThreadsPanel() {
		System.out.println("TEST TEST TEST");
	}

	
}